<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Cartões - Controle de Finanças</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon"
        href="https://raw.githubusercontent.com/CaioFerAmorim/controle-financas/refs/heads/main/static/img/logoWildMoneyIcon.ico"
        type="image/x-icon">
</head>

<body class="bg-light">

    <!-- Header -->
    <header class="text-white py-3" style="background-color: #1A4D2E;">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <img src="https://raw.githubusercontent.com/CaioFerAmorim/controle-financas/e24343c1468b7c5f06a8230f0913f834dab0635b/static/img/logoWildMoney.png"
                    alt="Logo" class="me-3" style="width:80px; height:80px;">
                <div>
                    <h1 class="h5 mb-0">Controle de Finanças</h1>
                    <small>Gerencie seus gastos</small>
                </div>
            </div>
            <nav>
                <a href="{{ url_for('index') }}" class="text-white text-decoration-none me-3">Início</a>
                <a href="{{ url_for('lancamentos') }}" class="text-white text-decoration-none me-3">Lançamentos</a>
                <a href="{{ url_for('projecoes') }}" class="text-white text-decoration-none me-3">Projeções</a>
                <a href="{{ url_for('visaoGeral') }}" class="text-white text-decoration-none">Visão Geral</a>
            </nav>
        </div>
    </header>

    <div class="d-flex">
        <!-- Sidebar -->
        <nav class="bg-dark text-white vh-100 p-3" style="width: 200px;">
            <h4>Opções</h4>
            <ul class="nav flex-column">
                <li class="nav-item"><a href="{{ url_for('lancamentos') }}" class="nav-link text-white">Despesas</a>
                </li>
                <li class="nav-item"><a href="{{ url_for('lancamentosReceita') }}"
                        class="nav-link text-white">Receitas</a></li>
                <li class="nav-item"><a href="{{ url_for('lancamentosConta') }}" class="nav-link text-white">Contas</a>
                </li>
                <li class="nav-item"><a href="{{ url_for('lancamentosCartao') }}"
                        class="nav-link text-white">Cartões</a></li>
                <li class="nav-item"><a href="{{ url_for('lancamentosCategorias') }}"
                        class="nav-link text-white">Categorias</a></li>
            </ul>
        </nav>

        <!-- Conteúdo principal -->
        <div class="container mt-4">
            <div class="row g-4">
                <div class="col-md-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-dark text-white text-center">Cartões de Crédito/Débito</div>
                        <div class="card-body">
                            <form id="formCartoes" class="mb-3">
                                <div class="row g-2 align-items-center">
                                    <!-- Linha 1 -->
                                    <div class="col-md-3">
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-end-0 small">Nome do
                                                Cartão</span>
                                            <input type="text" class="form-control border-start-0" id="nomeCartao"
                                                placeholder="Ex: Nubank, Itaú..." required>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-end-0 small">Conta
                                                Vinculada</span>
                                            <select class="form-select border-start-0" id="conta" required>
                                                <option value="">Selecione...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-end-0 small">Tipo</span>
                                            <select class="form-select border-start-0" id="tipoPagamento" required>
                                                <option value="credito">Crédito</option>
                                                <option value="debito">Débito</option>
                                                <option value="multiplo">Múltiplo</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-end-0 small">Dia
                                                Fechamento</span>
                                            <select class="form-select border-start-0" id="diasFechamento">
                                                <option value="">-</option>
                                                <!-- Dias 1-31 serão preenchidos via JavaScript -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-end-0 small">Dia
                                                Vencimento</span>
                                            <select class="form-select border-start-0" id="dataVencimento">
                                                <option value="">-</option>
                                                <!-- Dias 1-31 serão preenchidos via JavaScript -->
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-2 mt-2 align-items-center">
                                    <!-- Linha 2 -->
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-end-0 small">Limite R$</span>
                                            <input type="number" class="form-control border-start-0" id="limite"
                                                placeholder="0,00" step="0.01" value="0">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-text">
                                            <small>Para cartões de débito, limite é zero. Campos de
                                                fechamento/vencimento são opcionais para débito.</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="submit" class="btn btn-success w-100">Adicionar Cartão</button>
                                    </div>
                                </div>
                            </form>

                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Nome</th>
                                        <th>Conta</th>
                                        <th>Tipo</th>
                                        <th>Fechamento</th>
                                        <th>Vencimento</th>
                                        <th class="text-end">Limite (R$)</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaCartoes">
                                    {% for cartao in cartoes %}
                                    <tr data-id="{{ cartao[0] }}">
                                        <td>{{ cartao[1] }}</td>
                                        <td>{{ cartao[2] }}</td>
                                        <td>
                                            {% if cartao[5] == 'credito' %}
                                            Crédito
                                            {% elif cartao[5] == 'debito' %}
                                            Débito
                                            {% else %}
                                            Múltiplo
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if cartao[3] %}
                                            {{ cartao[3] }}
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if cartao[4] %}
                                            {{ cartao[4] }}
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td class="text-end">R$ {{ "%.2f"|format(cartao[6]) }}</td>
                                        <td class="text-center">
                                            <button class="btn btn-danger btn-sm btn-remover-cartao">Remover</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const formCartoes = document.getElementById("formCartoes");
            const selectConta = document.getElementById("conta");
            const selectDiasFechamento = document.getElementById("diasFechamento");
            const selectDataVencimento = document.getElementById("dataVencimento");
            const selectTipoPagamento = document.getElementById("tipoPagamento");
            const inputLimite = document.getElementById("limite");

            // Preencher dias 1-31 para fechamento e vencimento
            function preencherDias() {
                for (let i = 1; i <= 31; i++) {
                    const optionFechamento = document.createElement("option");
                    optionFechamento.value = i;
                    optionFechamento.textContent = i;
                    selectDiasFechamento.appendChild(optionFechamento);

                    const optionVencimento = document.createElement("option");
                    optionVencimento.value = i;
                    optionVencimento.textContent = i;
                    selectDataVencimento.appendChild(optionVencimento);
                }
            }

            // Controlar campos baseado no tipo de cartão
            selectTipoPagamento.addEventListener("change", function () {
                const tipo = this.value;

                if (tipo === 'debito') {
                    // Débito: desabilita limite e campos de crédito
                    inputLimite.value = "0";
                    inputLimite.disabled = true;
                    inputLimite.style.backgroundColor = '#e9ecef';
                    selectDiasFechamento.disabled = true;
                    selectDataVencimento.disabled = true;
                } else {
                    // Crédito ou múltiplo: habilita campos
                    inputLimite.disabled = false;
                    inputLimite.style.backgroundColor = '';
                    selectDiasFechamento.disabled = false;
                    selectDataVencimento.disabled = false;

                    if (inputLimite.value === "0") {
                        inputLimite.value = "";
                    }
                }
            });

            // Carregar contas disponíveis
            function carregarContas() {
                fetch("/api/contas")
                    .then(r => r.json())
                    .then(data => {
                        selectConta.innerHTML = '<option value="">Selecione...</option>';
                        data.contas.forEach(conta => {
                            const option = document.createElement("option");
                            option.value = conta.id;
                            option.textContent = conta.nome;
                            selectConta.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Erro ao carregar contas:", error);
                    });
            }

            // Enviar formulário de cartão
            formCartoes.addEventListener("submit", (e) => {
                e.preventDefault();

                const nome = document.getElementById("nomeCartao").value.trim();
                const contaId = selectConta.value;
                const tipoPagamento = selectTipoPagamento.value;
                const dataVencimento = selectDataVencimento.value || null;
                const diasFechamento = selectDiasFechamento.value || null;
                const limite = parseFloat(inputLimite.value) || 0;

                // Validações
                if (!nome || !contaId || !tipoPagamento) {
                    alert("Preencha todos os campos obrigatórios");
                    return;
                }

                // Validação específica para cartões de crédito
                if (tipoPagamento !== 'debito' && (!dataVencimento || !diasFechamento)) {
                    alert("Para cartões de crédito, informe dias de fechamento e vencimento");
                    return;
                }

                // Preparar dados para envio
                const dadosCartao = {
                    nome,
                    conta: contaId,
                    tipo_pagamento: tipoPagamento,
                    data_vencimento: dataVencimento,
                    dias_fechamento: diasFechamento,
                    limite: limite
                };

                fetch("/api/adicionar_cartao", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(dadosCartao)
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            alert("Cartão adicionado com sucesso!");
                            formCartoes.reset();
                            location.reload(); // Recarregar a página para mostrar o novo cartão
                        } else {
                            alert("Erro ao adicionar cartão: " + (data.error || "Erro desconhecido"));
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao adicionar cartão:", error);
                        alert("Erro de conexão ao adicionar cartão");
                    });
            });

            // Eventos para remover cartões
            document.querySelectorAll('.btn-remover-cartao').forEach(btn => {
                btn.addEventListener('click', function () {
                    const cartaoId = this.closest('tr').dataset.id;

                    if (!confirm("Tem certeza que deseja remover este cartão?")) return;

                    fetch("/api/remover_cartao", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id: cartaoId })
                    })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                alert("Cartão removido com sucesso!");
                                location.reload();
                            } else {
                                alert("Erro ao remover cartão: " + (data.error || "Erro desconhecido"));
                            }
                        })
                        .catch(error => {
                            console.error("Erro ao remover cartão:", error);
                            alert("Erro de conexão ao remover cartão");
                        });
                });
            });

            // Inicializar
            preencherDias();
            carregarContas();
        });
    </script>

</body>

</html>